name: Terraform Tests, Docs & Compliance

on:
  workflow_call:
    inputs:
      module_dirs:
        required: true
        type: string
      tf_version:
        required: false
        type: string
        default: 1.1.0

jobs:
  tf-validate:
    name: Terraform validate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dir: ${{fromJson(inputs.module_dirs)}}

    steps:
      - name: Checkout source code
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1 # v2.0.3
        with:
          terraform_version: ${{ inputs.tf_version }}

      - name: Terraform validation
        working-directory: ${{ matrix.dir }}
        run: |
          terraform init -reconfigure
          terraform fmt -recursive -check
          terraform validate

  tf-docs:
    name: Terraform documentation
    runs-on: ubuntu-latest
    needs: tf-validate
    strategy:
      matrix:
        dir: ${{fromJson(inputs.module_dirs)}}

    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Render terraform docs inside the README.md and push changes back to PR branch
        uses: terraform-docs/gh-actions@f6d59f89a280fa0a3febf55ef68f146784b20ba0 # renovate: tag=v1.0.0
        with:
          working-dir: ${{ matrix.dir }}
          output-file: README.md
          output-method: inject
          git-push: "true"

  checkov-scan:
    name: Run policy scan
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dir: ${{fromJson(inputs.module_dirs)}}

    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ inputs.tf_version }}
          terraform_wrapper: false
      - name: Run Checkov action
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ matrix.dir }}
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,results.sarif
          download_external_modules: true
          skip_check: CKV_TF_1,CKV_K8S_21,CKV_GCP_97,CKV_GCP_114,CKV_GCP_62,CKV2_GCP_13,CKV_GCP_14,CKV_GCP_51,CKV_GCP_52,CKV_GCP_53,CKV_GCP_54,CKV_GCP_55,CKV_GCP_57,CKV_GCP_11,CKV_GCP_56,CKV_GCP_60,CKV_GCP_79,CKV_GCP_108,CKV_GCP_109,CKV_GCP_111,CKV_GCP_6,CKV2_GCP_20,CKV2_GCP_14,CKV2_GCP_15,CKV2_GCP_16,CKV2_GCP_17,CKV2_GCP_7,CKV_AZURE_189
      - name: Upload Checkov SARIF results
        uses: github/codeql-action/upload-sarif@v2
        # upload results even if the action fails:
        if: success() || failure()
        with:
          sarif_file: results.sarif
